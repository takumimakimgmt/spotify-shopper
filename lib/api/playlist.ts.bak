import { ApiPlaylistResponse } from '../types';
import { warmupBackend } from './client';
import { fetchJsonWithBase, getBackendUrl } from './client';

export async function getPlaylist(params: {
  url: string;
  source: 'spotify';
  refresh?: boolean;
  signal?: AbortSignal;
}): Promise<ApiPlaylistResponse> {
  const search = new URLSearchParams({ url: params.url, source: params.source });
  }
  if (params.refresh) {
    search.set('refresh', '1');
  }
    search.set('enrich_spotify', val);
  }
  await warmupBackend();
  return fetchJsonWithBase<ApiPlaylistResponse>(`/api/playlist?${search.toString()}`, {
    signal: params.signal,
  });
}

export async function postPlaylistWithRekordboxUpload(params: {
  url: string;
  source: 'spotify';
  file: File;
  refresh?: boolean;
  signal?: AbortSignal;
}): Promise<ApiPlaylistResponse> {
  const form = new FormData();
  form.append('url', params.url);
  form.append('source', params.source);
  form.append('file', params.file);
  form.append('rekordbox_xml', params.file);
  }
  if (params.refresh) {
    form.append('refresh', '1');
  }
  }

  await warmupBackend();
  return fetchJsonWithBase<ApiPlaylistResponse>('/api/playlist-with-rekordbox-upload', {
    method: 'POST',
    body: form,
    signal: params.signal,
  });
}

export async function matchSnapshotWithXml(snapshotJson: string, file: File): Promise<ApiPlaylistResponse> {
  const form = new FormData();
  form.append('snapshot', snapshotJson);
  form.append('file', file);

  const _backend = getBackendUrl() ?? '';

  await warmupBackend();
  return fetchJsonWithBase<ApiPlaylistResponse>('/api/match-snapshot-with-xml', {
    method: 'POST',
    body: form,
  });
}
